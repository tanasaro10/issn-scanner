<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISSN Scanner → Sheet</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 14px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-bottom: 14px; }
    video { width: 100%; border-radius: 12px; background: #000; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background: #f6f6f6; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .log { font-family: ui-monospace, SFMono-Regular, Consolas, monospace; white-space: pre-wrap; }
    .ok { color: #0a7a0a; } .err { color: #b00020; }
    input[type=text] { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
    label { font-size: 14px; color: #444; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
</head>
<body>
  <h2>Scanează ISSN → Google Sheet</h2>

  <div class="card">
    <div class="row">
      <button id="startBtn">Start cameră</button>
      <button id="stopBtn" disabled>Stop cameră</button>
      <button id="toggleTorchBtn" disabled>Torch</button>
    </div>
    <div style="margin-top:10px">
      <video id="preview" playsinline muted></video>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div style="flex:1">
        <label>Endpoint Apps Script</label>
        <input id="webhook" type="text" placeholder="https://script.google.com/macros/s/AKfycbwcK6vutyz7ROy1cAo5kXe_Npqpxhm472yaom9cLhczCTO-LhULkqDqp-AiFIjEzhVLvw/exec" />
      </div>
      <div style="flex-basis:200px">
        <label>Token</label>
        <input id="token" type="text" placeholder="dsdasljhl32e32dasdasdaa_damkedsda" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <label>Device ID (opțional)</label>
        <input id="deviceId" type="text" placeholder="ex. phone01" />
      </div>
    </div>
  </div>

  <div class="card">
    <div><strong>Ultima detecție</strong></div>
    <div id="last" class="log"></div>
  </div>

<script>
  // UI helpers
  function show(msg, cls='') {
    const lastEl = document.getElementById('last');
    lastEl.innerHTML = `<div class="${cls}">${msg}</div>` + lastEl.innerHTML;
  }

  // Verifică context sigur (HTTPS/localhost)
  (function checkSecureContext(){
    const isSecure = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';
    if (!isSecure) {
      show('Pagina nu rulează în context sigur (HTTPS). Camera nu va porni.', 'err');
    }
    if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)) {
      show('Acest browser nu suportă getUserMedia sau accesul la cameră este dezactivat.', 'err');
    }
  })();

  // Enumeră camerele și adaugă un selector
  async function listCameras() {
    try {
      // O cerere „doar pentru prompt” (audio off, video true) poate debloca labels pe iOS
      try {
        await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      } catch(e) { /* ignorăm, doar ca să apară promptul */ }

      const devices = await navigator.mediaDevices.enumerateDevices();
      const videos = devices.filter(d => d.kind === 'videoinput');
      let sel = document.getElementById('cameraSel');
      if (!sel) {
        const wrap = document.createElement('div');
        wrap.className = 'card';
        wrap.innerHTML = `
          <div class="row">
            <div style="flex:1">
              <label>Alege camera</label>
              <select id="cameraSel" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc"></select>
            </div>
          </div>`;
        document.body.insertBefore(wrap, document.body.children[2]);
        sel = wrap.querySelector('#cameraSel');
      }
      sel.innerHTML = '';
      videos.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.deviceId;
        opt.textContent = v.label || 'Camera';
        sel.appendChild(opt);
      });
      // Heuristic: alege „back” dacă apare în label
      const back = Array.from(sel.options).find(o => /back|rear|spate/i.test(o.textContent));
      if (back) sel.value = back.value;
      return sel.value || undefined;
    } catch (e) {
      show('Nu pot enumera camerele: ' + e.message, 'err');
      return undefined;
    }
  }

  async function getFacingModeConstraint() {
    // Preferăm camera „environment”
    return { facingMode: { ideal: 'environment' } };
  }

  // ZXing setup
  const { BrowserMultiFormatReader } = ZXingBrowser;
  const codeReader = new BrowserMultiFormatReader();
  const preview = document.getElementById('preview');
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const torchBtn = document.getElementById('toggleTorchBtn');
  const webhookEl= document.getElementById('webhook');
  const tokenEl  = document.getElementById('token');
  const deviceEl = document.getElementById('deviceId');

  let currentCtrl = null;
  let torchOn = false;
  let lastEan = null;
  let lastAt = 0;

  function issnFromEan13(ean) {
    if (!/^\d{13}$/.test(ean) || !ean.startsWith('977')) return null;
    const issn7 = ean.substring(3, 10);
    const variant = ean.substring(10, 12);
    const weights = [8,7,6,5,4,3,2];
    let sum = 0;
    for (let i=0;i<7;i++) sum += parseInt(issn7[i],10) * weights[i];
    const r = sum % 11;
    let cd = (11 - r) % 11;
    const check = (cd === 10) ? 'X' : String(cd);
    const issn = issn7.substring(0,4)+'-'+issn7.substring(4) + check;
    return { issn, variantCode: variant };
  }

  async function lookupTitleByISSN(issn) {
    try {
      const url = `https://api.crossref.org/journals/${encodeURIComponent(issn)}`;
      const r = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if (!r.ok) throw new Error('lookup failed');
      const j = await r.json();
      return j?.message?.title || j?.message?.publisher || '—';
    } catch (e) { return '—'; }
  }

  async function postToSheet(webhook, token, payload) {
    const body = JSON.stringify({ token, ...payload });
    const r = await fetch(webhook, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body
    });
    let ok = false, info = '';
    try { const j = await r.json(); ok = !!j.ok; info = j.error || ''; } catch {}
    return { ok, info };
  }

  async function start() {
    try {
      // Alege camera disponibilă (sau default cu facingMode)
      const deviceId = await listCameras();
      const constraints = deviceId
        ? { video: { deviceId: { exact: deviceId } }, audio: false }
        : { video: await getFacingModeConstraint(), audio: false };

      // Cerem direct un stream ca să declanșăm promptul clar
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      preview.srcObject = stream;

      // Pornește ZXing
      const controls = await codeReader.decodeFromVideoDevice(
        deviceId || undefined,
        preview,
        async (result, err, controls) => {
          if (controls && !currentCtrl) currentCtrl = controls;
          if (result) {
            const raw = result.getText().trim();
            const now = Date.now();
            if (raw === lastEan && (now - lastAt) < 2000) return;
            lastEan = raw; lastAt = now;

            if (!/^\d{13}$/.test(raw)) { show(`Ignorat (nu e EAN-13): ${raw}`); return; }

            let title = '—', variantCode = '', issn = null;
            if (raw.startsWith('977')) {
              const parsed = issnFromEan13(raw);
              if (parsed) {
                issn = parsed.issn; variantCode = parsed.variantCode;
                title = await lookupTitleByISSN(issn);
              }
            } else {
              show(`Detectat ISBN-EAN (${raw}). App-ul e pentru ISSN (977).`, 'err');
            }

            const webhook = webhookEl.value.trim();
            const token = tokenEl.value.trim();
            if (!webhook || !token) {
              show(`EAN: ${raw}\nISSN: ${issn || '—'}\nTitlu: ${title}\n(Configurează Webhook & Token)`, 'err');
              return;
            }
            const resp = await postToSheet(webhook, token, {
              ean: raw, issn, title, variantCode, deviceId: deviceEl.value.trim() || ''
            });
            if (resp.ok) show(`✔ Salvat\nEAN: ${raw}\nISSN: ${issn || '—'}\nTitlu: ${title}\nVariant: ${variantCode}`, 'ok');
            else show(`✖ Eroare la salvare: ${resp.info || '(unknown)'}\nEAN: ${raw}`, 'err');
          }
        }
      );
      currentCtrl = controls;

      // UI
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;

      // Torch (dacă suportat)
      try {
        const track = preview.srcObject?.getVideoTracks?.[0];
        const capabilities = track?.getCapabilities?.();
        if (capabilities && 'torch' in capabilities) {
          document.getElementById('toggleTorchBtn').disabled = false;
        }
      } catch {}

    } catch (e) {
      // Mesaje prietenoase pentru cele mai comune erori
      if (e.name === 'NotAllowedError' || e.name === 'SecurityError') {
        show('Acces la cameră BLOCAȚ: verifică permisiunea pentru acest site (vezi pașii de mai sus).', 'err');
      } else if (e.name === 'NotFoundError' || e.message?.includes('Could not start video source')) {
        show('Nu găsesc nicio cameră disponibilă (sau e ocupată de altă aplicație). Închide alte aplicații de cameră și reîncearcă.', 'err');
      } else if (e.name === 'NotReadableError') {
        show('Camera este ocupată sau blocată de sistem. Repornește browserul/telefonul.', 'err');
      } else if (e.name === 'OverconstrainedError') {
        show('Constrângeri video prea stricte pentru camera curentă. Alege altă cameră din selector.', 'err');
      } else {
        show('Eroare la pornirea camerei: ' + (e.message || e.name), 'err');
      }
    }
  }

  function stop() {
    try { currentCtrl?.stop(); } catch {}
    try {
      const tracks = preview.srcObject?.getTracks?.() || [];
      tracks.forEach(t => t.stop());
      preview.srcObject = null;
    } catch {}
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('toggleTorchBtn').disabled = true;
  }

  async function toggleTorch() {
    const track = preview.srcObject?.getVideoTracks?.[0];
    if (!track) return;
    try {
      const caps = track.getCapabilities?.();
      if (!caps || !('torch' in caps)) return show('Torch nesuportat pe acest device.', 'err');
      const settings = track.getSettings?.() || {};
      await track.applyConstraints({ advanced: [{ torch: !settings.torch }] });
    } catch (e) {
      show('Nu pot porni/opri lanterna: ' + e.message, 'err');
    }
  }

  document.getElementById('startBtn').addEventListener('click', start);
  document.getElementById('stopBtn').addEventListener('click', stop);
  document.getElementById('toggleTorchBtn').addEventListener('click', toggleTorch);
  window.addEventListener('beforeunload', stop);
</script>

</body>
</html>
