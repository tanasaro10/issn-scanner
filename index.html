<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISSN Scanner → Sheet</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 14px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-bottom: 14px; }
    video { width: 100%; border-radius: 12px; background: #000; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background: #f6f6f6; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .log { font-family: ui-monospace, SFMono-Regular, Consolas, monospace; white-space: pre-wrap; }
    .ok { color: #0a7a0a; } .err { color: #b00020; }
    input[type=text] { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
    label { font-size: 14px; color: #444; }
  </style>

  <!-- ZXing: primary CDN + fallback -->
  <script
    id="zxing-cdn"
    src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"
    defer
    onerror="(function(){ 
      var s=document.createElement('script'); 
      s.src='https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js'; 
      s.defer=true; 
      s.onload=function(){ window.__zxingReady = true; };
      document.head.appendChild(s);
    })()"
    onload="window.__zxingReady = true;"
  ></script>
</head>
<body>
  <h2>Scanează ISSN → Google Sheet</h2>

  <div class="card">
    <div class="row">
      <button id="startBtn" onclick="window.__start && window.__start()">Start cameră</button>
      <button id="stopBtn" disabled onclick="window.__stop && window.__stop()">Stop cameră</button>
      <button id="toggleTorchBtn" disabled onclick="window.__torch && window.__torch()">Torch</button>
    </div>
    <div style="margin-top:10px">
      <video id="preview" playsinline muted></video>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div style="flex:1">
        <label>Endpoint Apps Script</label>
        <input id="webhook" type="text" placeholder="YOUR_APPS_SCRIPT_WEBAPP_URL" />
      </div>
      <div style="flex-basis:200px">
        <label>Token</label>
        <input id="token" type="text" placeholder="REPLACE_WITH_SECRET" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <label>Device ID (opțional)</label>
        <input id="deviceId" type="text" placeholder="ex. phone01" />
      </div>
    </div>
  </div>

  <div class="card">
    <div><strong>Ultima detecție</strong></div>
    <div id="last" class="log"></div>
  </div>

  <script>
    // — Helper pentru log —
    function _show(msg, cls='') {
      const last = document.getElementById('last');
      if (last) last.innerHTML = `<div class="${cls}">${msg}</div>` + last.innerHTML;
    }

    // — Așteaptă să se încarce ZXing —
    async function waitForZXing(timeoutMs=6000) {
      const start = Date.now();
      while (typeof window.ZXingBrowser === 'undefined' && (Date.now() - start) < timeoutMs) {
        await new Promise(r => setTimeout(r, 100));
      }
      return (typeof window.ZXingBrowser !== 'undefined');
    }

    (async function bootstrap(){
      if (!window.isSecureContext && location.protocol !== 'https:' && location.hostname !== 'localhost') {
        _show('Pagina nu e pe HTTPS: accesul la cameră poate fi blocat.', 'err');
      }

      const ok = await waitForZXing();
      if (!ok) {
        _show('Nu s-a putut încărca biblioteca ZXing. Verifică dacă nu blochează un ad blocker cdn.jsdelivr.net/unpkg.com.', 'err');
        // fallback: butoanele doar afișează mesaje
        window.__start = () => _show('ZXing indisponibil — scanarea codurilor e dezactivată.', 'err');
        window.__stop  = () => {};
        window.__torch = () => {};
        return;
      }

      // — Avem ZXing, definim logica —
      const { BrowserMultiFormatReader } = window.ZXingBrowser;
      const codeReader = new BrowserMultiFormatReader();

      const preview = document.getElementById('preview');
      const startBtn = document.getElementById('startBtn');
      const stopBtn  = document.getElementById('stopBtn');
      const torchBtn = document.getElementById('toggleTorchBtn');
      const webhookEl= document.getElementById('webhook');
      const tokenEl  = document.getElementById('token');
      const deviceEl = document.getElementById('deviceId');

      let currentCtrl = null, lastEan = null, lastAt = 0;

      function issnFromEan13(ean) {
        if (!/^\d{13}$/.test(ean) || !ean.startsWith('977')) return null;
        const issn7 = ean.substring(3, 10), variant = ean.substring(10, 12);
        const weights = [8,7,6,5,4,3,2];
        let sum = 0; for (let i=0;i<7;i++) sum += (+issn7[i]) * weights[i];
        const r = sum % 11, cd = (11 - r) % 11, check = (cd === 10) ? 'X' : String(cd);
        return { issn: issn7.slice(0,4)+'-'+issn7.slice(4)+check, variantCode: variant };
      }

      async function lookupTitleByISSN(issn) {
        try {
          const r = await fetch(`https://api.crossref.org/journals/${encodeURIComponent(issn)}`, { headers:{Accept:'application/json'} });
          if (!r.ok) throw 0; const j = await r.json();
          return j?.message?.title || j?.message?.publisher || '—';
        } catch { return '—'; }
      }

      async function postToSheet(webhook, token, payload) {
        try {
          const r = await fetch(webhook, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token, ...payload }) });
          const j = await r.json().catch(()=> ({}));
          return { ok: !!j.ok, info: j.error || '' };
        } catch(e){ return { ok:false, info: String(e) }; }
      }

      async function start() {
        try {
          const controls = await codeReader.decodeFromVideoDevice(undefined, preview, async (result, err, controls) => {
            if (controls && !currentCtrl) currentCtrl = controls;
            if (!result) return;

            const raw = result.getText().trim();
            const now = Date.now();
            if (raw === lastEan && (now - lastAt) < 2000) return;
            lastEan = raw; lastAt = now;

            if (!/^\d{13}$/.test(raw)) return _show(`Ignorat (nu e EAN-13): ${raw}`);
            let issn = null, title = '—', variantCode = '';

            if (raw.startsWith('977')) {
              const p = issnFromEan13(raw);
              if (p) { issn = p.issn; variantCode = p.variantCode; title = await lookupTitleByISSN(issn); }
            } else {
              _show(`Detectat ISBN (${raw}). App-ul e pentru ISSN (977).`, 'err');
            }

            const webhook = webhookEl.value.trim(), token = tokenEl.value.trim();
            if (!webhook || !token) return _show(`EAN: ${raw}\nISSN: ${issn||'—'}\nTitlu: ${title}\n(Configurează Webhook & Token)`, 'err');

            const resp = await postToSheet(webhook, token, { ean: raw, issn, title, variantCode, deviceId: deviceEl.value.trim() });
            if (resp.ok) _show(`✔ Salvat\nEAN: ${raw}\nISSN: ${issn||'—'}\nTitlu: ${title}\nVariant: ${variantCode}`, 'ok');
            else _show(`✖ Eroare la salvare: ${resp.info||'(unknown)'}\nEAN: ${raw}`, 'err');
          });
          currentCtrl = controls;
          startBtn.disabled = true; stopBtn.disabled = false;

          // Torch dacă există
          try {
            const track = preview.srcObject?.getVideoTracks?.[0];
            const caps = track?.getCapabilities?.();
            if (caps && 'torch' in caps) torchBtn.disabled = false;
          } catch {}
        } catch (e) {
          if (e.name === 'NotAllowedError' || e.name === 'SecurityError') _show('Acces la cameră blocat de permisiuni.', 'err');
          else if (e.name === 'NotFoundError') _show('Nu există cameră disponibilă.', 'err');
          else _show('Eroare pornire cameră: ' + (e.message || e.name), 'err');
        }
      }

      function stop() {
        try { currentCtrl?.stop(); } catch {}
        try { preview.srcObject?.getTracks?.().forEach(t=>t.stop()); preview.srcObject = null; } catch {}
        startBtn.disabled = false; stopBtn.disabled = true; torchBtn.disabled = true;
      }

      async function toggleTorch() {
        const track = preview.srcObject?.getVideoTracks?.[0];
        if (!track) return;
        try {
          const caps = track.getCapabilities?.(); if (!caps || !('torch' in caps)) return _show('Torch nesuportat.', 'err');
          const st = track.getSettings?.()||{};
          await track.applyConstraints({ advanced:[{ torch: !st.torch }] });
        } catch (e) { _show('Nu pot controla lanterna: ' + e.message, 'err'); }
      }

      // fallback global
      window.__start = start; window.__stop = stop; window.__torch = toggleTorch;
    })();
  </script>
</body>
</html>
